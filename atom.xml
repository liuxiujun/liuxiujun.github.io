<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>liuxiujun</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://liuxiujun.github.into/"/>
  <updated>2020-02-07T04:39:42.877Z</updated>
  <id>https://liuxiujun.github.into/</id>
  
  <author>
    <name>liuxiujun</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>青海甘肃环线旅行</title>
    <link href="https://liuxiujun.github.into/2020/02/05/%E9%9D%92%E6%B5%B7%E7%94%98%E8%82%83%E7%8E%AF%E7%BA%BF%E6%97%85%E8%A1%8C/"/>
    <id>https://liuxiujun.github.into/2020/02/05/%E9%9D%92%E6%B5%B7%E7%94%98%E8%82%83%E7%8E%AF%E7%BA%BF%E6%97%85%E8%A1%8C/</id>
    <published>2020-02-05T15:02:06.000Z</published>
    <updated>2020-02-07T04:39:42.877Z</updated>
    
    <content type="html"><![CDATA[<p>去年春节在拉萨租车转了几天意犹未尽，原本今年的计划是自驾滇藏线进青藏线出，算了下只是进藏路线大概就需要7天左右， 临时改计划来个青海甘肃大环线。</p><p>用时9天半，6745km</p><p><strong>DAY0    威海 - 淄博 445km</strong></p><p>下班吃了顿水饺，加满油出发。还没出城就已经感觉自己像风一样自由，一顿操作猛如虎，一看码表五十五；</p><p>在威青，青银高速上听着周杰伦开了5个多小时，虽然是夜里也没看着什么景，但还是挺开心的。凌晨下高速进淄博市里住宿。</p><p><strong>DAY1    淄博 - 平遥 603km</strong></p><p>上午出发走青银，东吕高速，山东路段除了济南附近很堵，其余部分路况非常好，服务区很干净吃饭也很平价，完全颠覆了对服务区印象。</p><p>一路地形渐渐从平原变成了高山，从高山变成了丘陵，晚上到达平遥县，趁着夜色逛了逛古城，作为一个景点还算不错。</p><p><img src="/images/J1/1231581041033_.pic.jpg" alt></p><p><img src="/images/J1/1241581041033_.pic.jpg" alt></p><p><img src="/images/J1/1251581041033_.pic.jpg" alt></p><p>走了很远，在古城中心找到一家很火的饭馆，吃了平遥牛肉，烤姥姥，竹叶酒什么的地方特色。总体感觉没什么特色，景区平均水准。</p><p>古城是迄今保存最完好的明清时代的汉民族县城，基本上保留了200年前的样子。很多当地人目前仍然住在古城里，沿街除了几个重点保护建筑其余无一例外的都商业化了。我还是对小巷子里当地人真实的生活更感兴趣，不过老婆觉得小路太黑会危险，所以基本上都挑大路走，一边走一边猜哪个是地主家，衙门，镖局…对有些房子还有住户感觉很新奇。</p><p>回酒店的路上，看来往汽车开在古城的青砖路上，背景是各种饭馆，酒店，ktv，有种很魔幻的感觉。</p><p><strong>DAY2    平遥 - 西宁 1124km</strong></p><p>由于前一天抹黑进城，这天早上出发才在路上看清城市的样子，有点像走进了贾樟柯电影里的西北城市。</p><p>这一天跑的比较远，走的青银，定武，京藏高速，全程一千来公里。一路上风景非常漂亮，黄土高坡上的窑洞，盘山路上的隧道，平原上望不到头的公路，每过一段时间就像到了一个全新的世界，第一次直观的感受到中国实在是太大了。看到各种神奇的地貌又叫不上名字，感觉非常有必要补习下地理知识。</p><p>定武高速上漂亮的云。</p><p><img src="/images/J1/1261581041033_.pic.jpg" alt></p><p>风电园，照片里拍不出延绵几公里成千上万只风车的震撼。</p><p><img src="/images/J1/1271581041033_.pic.jpg" alt></p><p>敷衍的沙海绿洲服务区，这个标题党！</p><p><img src="/images/J1/1281581041033_.pic.jpg" alt></p><p>在平直的无人公路上测试了下小车速度居然能踩到164，感觉还有后劲，安全起见爽一下得了。</p><p>晚上9点进入西宁市区，又饿又累，找了个清真饭馆本来没抱什么希望，点了手抓，回族大叔问我们凉着吃还是烤着吃，我俩都懵了心想这么糊弄吗凉着就想上，还是烤烤吧，不管怎么样吃口热乎的。万万没想到，这吃法开启了新世界的大门，炒炮仗配着烤手抓，把我俩好吃哭了，不得不说青海羊肉天下无双！</p><p><img src="/images/J1/1291581041033_.pic.jpg" alt></p><p>总结经验，后半程摸黑跑山路还是不安全的，连着开14个小时，第二天腰都直不起来，如果时间充裕每天跑5-6个小时会比较放松。</p><p><strong>DAY3    西宁 - 青海湖 - 黑马河 238km</strong></p><p>一觉快睡到中午，起来直奔东关清真寺附近的手抓店，去年路过西宁的时候吃过一次从此对青海羊肉念念不忘。</p><p><img src="/images/J1/1311581041033_.pic.jpg" alt></p><p>八宝茶味道很足，如果有时间可以喝上一天；照片里没拍上用碗装的酸奶，很好喝很过瘾。回族饭馆的东西实在太和胃口了，想留在西宁。</p><p>吃饱喝足加满油出发，我们决定环线玩上一趟还要回西宁吃羊肉。</p><p>出了市区，往西走京藏高速，G109很快就能到青海湖；</p><p>提前查了路线没进二郎剑景区，花20块钱从藏族大娘的牧场直接开车到湖边，冰天雪地</p><p><img src="/images/J1/1301581041033_.pic.jpg" alt></p><p><img src="/images/J1/1711581046581_.pic.jpg" alt></p><p>看着很好吃的小羊。</p><p><img src="/images/J1/1331581041047_.pic.jpg" alt></p><p>晚上5点左右到黑马河镇，这里有个日出点可以看到第二天青海湖上的日出。</p><p>办完入住才知道这边冬季8点多日出，其实完全可以住在条件更好的共和县里，早起开2个小时左右可以赶上看日出。</p><p>中间出点小插曲，撞到了一辆逆行的轿车，藏民不懂交规纠缠了2个小时才解决问题，好在车速不快人平安，车子也没出什么问题。</p><p><strong>DAY4    黑马河 - 大柴旦 523km</strong></p><p>天不亮起床来到日出点，结果是阴天，日出没看成，看着旁边车的情侣对着航拍机在那蹦哒了一早上，哈哈哈…</p><p><img src="/images/J1/1341581041047_.pic.jpg" alt></p><p>继续向西，走茶德，德小高速，从草原开进雪山。</p><p><img src="/images/J1/1351581041047_.pic.jpg" alt></p><p>路过茶卡盐湖打卡点，看着围起来的景区和一路的广告我们都没有进去的兴趣，远远看一眼直接路过了。</p><p>傍晚开到大柴旦的翡翠湖，赶上日落，漂亮极了。</p><p><img src="/images/J1/1361581041047_.pic.jpg" alt></p><p><img src="/images/J1/1371581041047_.pic.jpg" alt></p><p>大柴旦被雪山和湖泊环绕，像生活在仙境里。</p><p>白天老婆说了一句晚上要是酒店过年不开怎么办，这乌鸦嘴，果然预定的酒店关门联系不上了，搞的差点除夕夜露宿街头，临时找了一家酒店没想到环境还很舒适，放好行李下楼吃饭，一出电梯正好碰上老板朝这个方向在拜财神，迎面一个大礼让我们迎上很尴尬，这酒店也太热情了。</p><p>镇上饭馆都关了，只剩几家清真的，进去之后才知道回族人是不过春节的。 年夜饭点了炕锅羊肉，牛排，沙葱，青海酸菜，跟前一天在黑马河一样炕锅羊肉又点翻车了，严重怀疑这菜即便是正宗了也只能做到这种程度。</p><p>街上很难看到行人，居民楼大部分黑着没几家亮灯，只有三四条街的镇子却到处都是酒店，能猜到旺季的时候这里一定是人山人海。</p><p><strong>DAY5    大柴旦 - 南八仙 - 大柴旦 380km</strong></p><p>这一天没什么具体行程，走哪算哪，前一天看到的翡翠湖实在是太漂亮了，所以上午我们决定还要去一趟。</p><p>翡翠湖需要从一个化工厂旁的小路穿过去，因为是个咸水湖所以被厂子当作了盐场。目前还是免费的，看周边正在施工的进度，应该很快就会被改造成收费景区了。如果景区商业化了就会出现很多人造的东西，失去湖泊本来的样子，而不商业化我们又很难知道有这么漂亮的地方，在此陷入矛盾中。</p><p>幸亏白天又来了一次，被这地方惊艳到了，水是翠绿色的，光折射率真高，看到了天空之境。</p><p><img src="/images/J1/1391581041047_.pic.jpg" alt></p><p><img src="/images/J1/1381581041047_.pic.jpg" alt></p><p>一边吃着前一天的凉牛肉，一边向南八仙出发，尽管路上基本是冰雪，但还不至于用上防滑链。越往西轮胎印越少，雪后来往的车并不多， 直到遇见第一辆对向开来的车，我才意识到这是条双向车道。</p><p><img src="/images/J1/1401581041047_.pic.jpg" alt></p><p>南八仙是雅丹地貌，几亿年前地壳运动翻上来的海底，看着像大坟包。我想如果我是当年迷路的科考队员，徒步的话肯定也是走不出去，没导航连北都找不着。手欠的我关了地图发现手机无服务，导航也不能规划路线，尴尬了…其实这样随心所欲的往前开也挺开心的。</p><p>溜达着想找个小山爬上去看看全貌，爬上去是一望无际的雅丹。</p><p><img src="/images/J1/1671581043508_.pic.jpg" alt></p><p>看着是坚硬的小山，其实是含盐的软土，混着雪踩上去拔不动脚，幸好带了两双鞋。</p><p><img src="/images/J1/1421581041058_.pic.jpg" alt></p><p>出发前多看了几眼地图，大致知道往前应该是格尔木，但没了导航又看不到一辆车确实心里还是有点虚，下次出门前一定要下离线地图，虽然顺着路开肯定不会丢，可一旦在不清楚里程的情况下开没了油，在这地方等过路车就要随缘了。</p><p>无人区的无名公路很长，很催眠。</p><p><img src="/images/J1/1721581048094_.pic.jpg" alt></p><p>G315国道，意外收获，无计划的开到了这条最美沙漠公路上，阳光很好很暖和。</p><p><img src="/images/J1/1431581041058_.pic.jpg" alt></p><p><img src="/images/J1/1451581041058_.pic.jpg" alt></p><p>往西是新疆阿克苏，往东是德令哈方向，傍晚路过小柴达木湖，太阳快落山了就没停车，看路牌上写着还有旧石器时代人类遗址，原始人还挺会找地方的，在这么漂亮的地方安家。</p><p>天黑后我们又回到了冰天雪地的大柴旦，神奇的一天。</p><p><strong>DAY6    大柴旦 - 敦煌 348km</strong></p><p>早上有点不舍的离开干净暖和的酒店，这个漂亮的小镇没待够，很想退休后住在这里。</p><p>全程走了一段公路，一段土路，最后翻过当金山进入甘肃界，三百来公里的路开了六七个小时，山路有一段连续26km的下坡，想起来去年在羊卓雍错把刹车踩软的事，当时没经验，拿瓶水浇一下刹车片就没事了。</p><p>山坡上居然有个院子，在这荒山里怎么生活的？<br><img src="/images/J1/1461581041058_.pic.jpg" alt></p><p>进甘肃境内越走越暖和，已经零上了，天黑前到了敦煌，不出所料由于疫情莫高窟和月牙泉都关了，只能远远的看一眼这个什么景区的大沙漠。</p><p><img src="/images/J1/1471581041058_.pic.jpg" alt></p><p>敦煌市里很干净，路上很多人为营造出来的古典元素，有点为了发展旅游业用力过猛的感觉。小吃街属于坑游客的地方，找了家高分饭馆，老板听到外地口音言语间急切的想宰上一刀，点了胡羊焖饼和烤羊排，说实话比西宁的手抓差远了，加上酒店的环境和服务态度都差，所以对这个城市的印象并不是很好。</p><p>疫情的气氛已经变得紧张了，街上都带着口罩，老婆开玩笑说不会回去的路上没吃没住的吧…这嘴就跟开了光一样的准。</p><p><strong>DAY7    敦煌 - 张掖 656km</strong></p><p>早起出发，一路风景跟前一天大同小异，到了张掖出口感觉到气氛又紧张了，外地车牌查的很严，意料之中七彩丹霞地质公园也是关闭了。</p><p><img src="/images/J1/1481581041058_.pic.jpg" alt></p><p>张掖是个漂亮的小城，但我们更关心的是吃啥，转了半个城区没找到一家营业的饭馆，只能在超市买些速食。之后跑了几个药店，口罩，温度计，板蓝根都脱销了。</p><p>隐隐觉得还是尽快返程比较好。</p><p><strong>DAY8    张掖 - 武威 - 延安 1053km</strong></p><p>按计划路线，这天要走G227经门源到西宁，刚开出10km左右被交警拦回掉头，国道沿途的村子害怕疫情私自堵路了，这就只能走连霍高速兰州方向，当即决定最短路线回威海。</p><p>在连霍高速上张掖到武威段，有一片十几公里的古长城遗址，看起来很有年代感的残垣断壁，想到敦煌的赝品古城被游客们趋之若鹜，这里的真品却自生自灭，突然间有点感慨。老婆说这样也挺好，喜欢这种事物本来的样子，终究会尘归尘土归土。几句天聊的暮气横秋…</p><p>夜里的风电园，风车上的小灯一闪一闪，变成了延绵几公里的小红点，绿色的杀马特探照灯对着天空一顿群魔乱舞…<br><img src="/images/J1/1491581041058_.pic.jpg" alt></p><p>开了一天有些累，在马尔庄服务区开始犯困，临时决定去最近的延安过夜。</p><p>路上突然想是不是应该考个A本，以后不干程序员了去开长途，我很有潜质啊，一边自驾一边工作也挺爽的…</p><p>开到凌晨才进市区，意外收获的延安夜景。</p><p><img src="/images/J1/1501581041064_.pic.jpg" alt></p><p>到了预定的酒店，外地身份证居然不让住了，折腾到后半夜，到了第三家酒店登记量体温终于住了进来，看到有些酒店的通知29日开始劝退所有已入住客人，很庆幸能找到个住处。</p><p><strong>DAY9    延安 - 威海 1376km</strong></p><p>经过前一天找酒店，我们感觉今天应该不会很容易再找到一个住处了，索性直接一把开到威海吧。</p><p>延安到山西段全程山路，翻山越岭穿隧道，山这边晴空万里穿过隧道另一边是能见度不足50m的大雾</p><p><img src="/images/J1/1511581041065_.pic.jpg" alt></p><p>青兰高速山西段连着3个服务区关闭真坑，找到能加油的服务区时就剩一格油了。</p><p>傍晚在邯郸服务区里检查体温，老婆38度多，一下围上来一群穿着防护服的。心想这下坏了，这要是隔离十天半个月的，家里两只猫可就得凉了。待了一会儿又测了几次体温正常，医生说是你这车里空调太热了给吹的…有惊无险。</p><p>进入山东界，跟山西相比山东高速真的很好跑，进度加快不少。一路上小服务区基本都关闭了无处停车，筋疲力尽的时候到了正常营业的天桥服务区，犹如黑夜中的一盏明灯。</p><p>休息的时候刷到一条新闻，武汉一个哥们封城之前自驾玩儿去，封城之后回不去了，没吃没住的在高速上流浪了6天。我说这哥们真惨，现实版人在囧途啊，可以拍个电影了，老婆一边说自己笑不出来，一边狂笑。</p><p>凌晨1点多回到了我们的出发地威海，有种过了很长时间的感觉，旅行真的会让时间变慢。</p><p>新的一年好好学习好好工作，期待下一次出发。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;去年春节在拉萨租车转了几天意犹未尽，原本今年的计划是自驾滇藏线进青藏线出，算了下只是进藏路线大概就需要7天左右， 临时改计划来个青海甘肃大环线。&lt;/p&gt;
&lt;p&gt;用时9天半，6745km&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;DAY0    威海 - 淄博 445km&lt;/strong
      
    
    </summary>
    
    
    
      <category term="旅行" scheme="https://liuxiujun.github.into/tags/%E6%97%85%E8%A1%8C/"/>
    
  </entry>
  
  <entry>
    <title>Mac平台VSCode配置C51开发环境</title>
    <link href="https://liuxiujun.github.into/2020/01/06/Mac%E5%B9%B3%E5%8F%B0VSCode%E9%85%8D%E7%BD%AEC51%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/"/>
    <id>https://liuxiujun.github.into/2020/01/06/Mac%E5%B9%B3%E5%8F%B0VSCode%E9%85%8D%E7%BD%AEC51%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/</id>
    <published>2020-01-06T10:35:08.000Z</published>
    <updated>2020-02-07T04:39:42.877Z</updated>
    
    <content type="html"><![CDATA[<h3 id="安装-sdcc-编译器"><a href="#安装-sdcc-编译器" class="headerlink" title="安装 sdcc 编译器"></a>安装 sdcc 编译器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install sdcc</span><br></pre></td></tr></table></figure><h3 id="安装CH341驱动"><a href="#安装CH341驱动" class="headerlink" title="安装CH341驱动"></a>安装CH341驱动</h3><blockquote><p> 开发版集成了usb转串口模块, 使用的是CH340芯片, 需要安装驱动</p></blockquote><p><a href="http://www.wch.cn/download/CH341SER_MAC_ZIP.html" target="_blank" rel="noopener">http://www.wch.cn/download/CH341SER_MAC_ZIP.html</a></p><h3 id="确认驱动是否安装成功"><a href="#确认驱动是否安装成功" class="headerlink" title="确认驱动是否安装成功"></a>确认驱动是否安装成功</h3><blockquote><p>需要把单片机连接上电脑</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ls /dev/tty.wchusbserial*</span></span><br><span class="line">/dev/tty.wchusbserial1420</span><br></pre></td></tr></table></figure><h3 id="安装-stcgal-烧录程序"><a href="#安装-stcgal-烧录程序" class="headerlink" title="安装 stcgal 烧录程序"></a>安装 stcgal 烧录程序</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install stcgal</span><br></pre></td></tr></table></figure><h3 id="VSCode-配置"><a href="#VSCode-配置" class="headerlink" title="VSCode 配置"></a>VSCode 配置</h3><p>需要安装 Code Runner 插件</p><p>编辑配置文件 <code>.vscode/c_cpp_properties.json</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"configurations"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"name"</span>: <span class="string">"51"</span>,</span><br><span class="line">            <span class="attr">"includePath"</span>: [</span><br><span class="line">                <span class="string">"$&#123;workspaceFolder&#125;/**"</span>,</span><br><span class="line">                <span class="string">"/usr/local/Cellar/sdcc/3.9.0/share/sdcc/include"</span>,</span><br><span class="line">                <span class="string">"/usr/local/Cellar/sdcc/3.9.0/share/sdcc/include/mcs51"</span></span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">"defines"</span>: [],</span><br><span class="line">            <span class="attr">"compilerPath"</span>: <span class="string">"/usr/local/Cellar/sdcc/3.9.0/bin/sdcc"</span>,</span><br><span class="line">            <span class="attr">"cStandard"</span>: <span class="string">"c11"</span>,</span><br><span class="line">            <span class="attr">"cppStandard"</span>: <span class="string">"c++17"</span>,</span><br><span class="line">            <span class="attr">"intelliSenseMode"</span>: <span class="string">"clang-x64"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"version"</span>: <span class="number">4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编辑配置文件 <code>.vscode/settings.json</code></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"files.associations"</span>: &#123;</span><br><span class="line">        <span class="attr">"8052.h"</span>: <span class="string">"c"</span>,</span><br><span class="line">        <span class="attr">"8051.h"</span>: <span class="string">"c"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"code-runner.executorMap"</span>: &#123;</span><br><span class="line">        <span class="attr">"c"</span>: <span class="string">"cd $dir &amp; sdcc $fileName &amp; stcgal -P stc89 -p /dev/tty.wchusbserial1420 $fileNameWithoutExt.ihx"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="第一个测试程序"><a href="#第一个测试程序" class="headerlink" title="第一个测试程序"></a>第一个测试程序</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;8052.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ADDR0 P0_0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ADDR0 = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>⌃⌥N 运行, 提示</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Waiting for MCU, please cycle power:</span><br></pre></td></tr></table></figure><p>开发版重新上电后，第一个led亮起</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;安装-sdcc-编译器&quot;&gt;&lt;a href=&quot;#安装-sdcc-编译器&quot; class=&quot;headerlink&quot; title=&quot;安装 sdcc 编译器&quot;&gt;&lt;/a&gt;安装 sdcc 编译器&lt;/h3&gt;&lt;figure class=&quot;highlight shell&quot;&gt;&lt;tabl
      
    
    </summary>
    
    
    
      <category term="单片机" scheme="https://liuxiujun.github.into/tags/%E5%8D%95%E7%89%87%E6%9C%BA/"/>
    
  </entry>
  
  <entry>
    <title>Python实现微服务从听过到略懂</title>
    <link href="https://liuxiujun.github.into/2019/12/30/Python%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BB%8E%E5%90%AC%E8%BF%87%E5%88%B0%E7%95%A5%E6%87%82/"/>
    <id>https://liuxiujun.github.into/2019/12/30/Python%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E4%BB%8E%E5%90%AC%E8%BF%87%E5%88%B0%E7%95%A5%E6%87%82/</id>
    <published>2019-12-30T08:45:26.000Z</published>
    <updated>2020-02-07T04:39:42.877Z</updated>
    
    <content type="html"><![CDATA[<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>python3, flask, python-consul, docker</p><h3 id="使用docker-拉取-consul"><a href="#使用docker-拉取-consul" class="headerlink" title="使用docker 拉取 consul"></a>使用docker 拉取 consul</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull consul</span><br></pre></td></tr></table></figure><h3 id="使用docker-compose-编排-consul-容器，-为了快速搞定注册发现这块，-启一个节点测试用，-生产环境别这么搞"><a href="#使用docker-compose-编排-consul-容器，-为了快速搞定注册发现这块，-启一个节点测试用，-生产环境别这么搞" class="headerlink" title="使用docker-compose 编排 consul 容器， 为了快速搞定注册发现这块， 启一个节点测试用， 生产环境别这么搞"></a>使用docker-compose 编排 consul 容器， 为了快速搞定注册发现这块， 启一个节点测试用， 生产环境别这么搞</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">version: '3.1'</span><br><span class="line">services:</span><br><span class="line">  consul:</span><br><span class="line">    image: consul</span><br><span class="line">    hostname: consul</span><br><span class="line">    container_name: badger</span><br><span class="line">    ports:</span><br><span class="line">      - 8500:8500</span><br><span class="line">      - 8600:8600/udp</span><br><span class="line">    command: agent -server -ui -node=server-1 -bootstrap-expect=1 -client=0.0.0.0</span><br></pre></td></tr></table></figure><h3 id="切换到-docker-compose-yml-所在目录运行"><a href="#切换到-docker-compose-yml-所在目录运行" class="headerlink" title="切换到 docker-compose.yml 所在目录运行"></a>切换到 docker-compose.yml 所在目录运行</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure><h3 id="访问8500"><a href="#访问8500" class="headerlink" title="访问8500"></a>访问8500</h3><p>…</p><h3 id="测试consul-DNS-解析"><a href="#测试consul-DNS-解析" class="headerlink" title="测试consul DNS 解析"></a>测试consul DNS 解析</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig @127.0.0.1 -p 8600 consul.service.dc1.consul. ANY</span><br></pre></td></tr></table></figure><h3 id="本机如果没有dig命令，-替代方法"><a href="#本机如果没有dig命令，-替代方法" class="headerlink" title="本机如果没有dig命令， 替代方法"></a><del>本机如果没有dig命令， 替代方法</del></h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm  azukiapp/dig:latest dig @0.0.0.0 -p 8600 consul.service.dc1.consul. ANY</span><br></pre></td></tr></table></figure><h3 id="上面的命令有问题…换成宿主机ip也不成？-先不研究这个，安装dig命令吧"><a href="#上面的命令有问题…换成宿主机ip也不成？-先不研究这个，安装dig命令吧" class="headerlink" title="上面的命令有问题…换成宿主机ip也不成？ 先不研究这个，安装dig命令吧"></a>上面的命令有问题…换成宿主机ip也不成？ 先不研究这个，安装dig命令吧</h3><h3 id="返回结果应该包含节点IP地址"><a href="#返回结果应该包含节点IP地址" class="headerlink" title="返回结果应该包含节点IP地址"></a>返回结果应该包含节点IP地址</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">; &lt;&lt;&gt;&gt; DiG 9.10.6 &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 consul.service.dc1.consul. ANY</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 16647</span><br><span class="line">;; flags: qr aa rd; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 1</span><br><span class="line">;; WARNING: recursion requested but not available</span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: 0, flags:; udp: 4096</span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;consul.service.dc1.consul.INANY</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">consul.service.dc1.consul. 0INA172.26.0.2</span><br><span class="line">consul.service.dc1.consul. 0INTXT"consul-network-segment="</span><br><span class="line"></span><br><span class="line">;; Query time: 15 msec</span><br><span class="line">;; SERVER: 127.0.0.1#8600(127.0.0.1)</span><br><span class="line">;; WHEN: Mon Dec 30 09:05:44 CST 2019</span><br><span class="line">;; MSG SIZE  rcvd: 106</span><br></pre></td></tr></table></figure><h3 id="搭建-flask-开发环境"><a href="#搭建-flask-开发环境" class="headerlink" title="搭建 flask 开发环境"></a>搭建 flask 开发环境</h3><h4 id="create-venv"><a href="#create-venv" class="headerlink" title="create venv"></a>create venv</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir myproject &amp;&amp; cd myproject &amp;&amp; python3 -m venv venv</span><br></pre></td></tr></table></figure><h4 id="active-venv"><a href="#active-venv" class="headerlink" title="active venv"></a>active venv</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">. venv/bin/activate</span><br></pre></td></tr></table></figure><h4 id="install-flask"><a href="#install-flask" class="headerlink" title="install flask"></a>install flask</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install flask</span><br><span class="line">pip install python-consul</span><br></pre></td></tr></table></figure><h2 id="现在正式开始"><a href="#现在正式开始" class="headerlink" title="现在正式开始"></a>现在正式开始</h2><h3 id="编写第一个服务-firstapp-py"><a href="#编写第一个服务-firstapp-py" class="headerlink" title="编写第一个服务, firstapp.py"></a>编写第一个服务, firstapp.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    ver=<span class="string">"1.0"</span></span><br><span class="line">    res=<span class="string">'&#123;"Service":"first app", "Version":'</span> + ver + <span class="string">'&#125;\n'</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure><h3 id="启动第一个服务"><a href="#启动第一个服务" class="headerlink" title="启动第一个服务"></a>启动第一个服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export FLASK_ENV=development &amp;&amp; export FLASK_APP=firstapp.py &amp;&amp; flask run --host=0.0.0.0 --port=5000</span><br></pre></td></tr></table></figure><h3 id="编写第二个服务，-secondapp-py"><a href="#编写第二个服务，-secondapp-py" class="headerlink" title="编写第二个服务， secondapp.py"></a>编写第二个服务， secondapp.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    ver=<span class="string">"1.0"</span></span><br><span class="line">    res=<span class="string">'&#123;"Service":"second app", "Version":'</span> + ver + <span class="string">'&#125;\n'</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure><h3 id="启动第二个服务"><a href="#启动第二个服务" class="headerlink" title="启动第二个服务"></a>启动第二个服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export FLASK_ENV=development &amp;&amp; export FLASK_APP=secondapp.py &amp;&amp; flask run --host=0.0.0.0 --port=5001</span><br></pre></td></tr></table></figure><h3 id="将两个服务注册到consul的脚本"><a href="#将两个服务注册到consul的脚本" class="headerlink" title="将两个服务注册到consul的脚本"></a>将两个服务注册到consul的脚本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">function register() &#123;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查询当前服务IP地址, 默认情况下docker容器内访问宿主机不能用127.0.0.1或localhost</span></span><br><span class="line">addr=`/sbin/ifconfig -a|grep inet|grep -v 127.0.0.1|grep -v inet6|awk '&#123;print $2&#125;'|tr -d "addr:"`</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注销服务</span></span><br><span class="line">curl -X PUT http://127.0.0.1:8500/v1/agent/service/deregister/$1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 注册服务</span></span><br><span class="line">curl -X PUT -d '&#123;</span><br><span class="line">"id": "'$1'", </span><br><span class="line">"name": "'$1'", </span><br><span class="line">"address": "'$&#123;addr&#125;'", </span><br><span class="line">"port": '$2', </span><br><span class="line">"tags": [""], </span><br><span class="line">"checks": [</span><br><span class="line">&#123;</span><br><span class="line">"http": "http://'$&#123;addr&#125;':'$2'",</span><br><span class="line">"interval": "5s"</span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line">&#125;' http://127.0.0.1:8500/v1/agent/service/register</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查询指定节点以及指定的服务信息</span></span><br><span class="line">curl http://127.0.0.1:8500/v1/catalog/service/$1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">servs=('firstapp 5000' 'secondapp 5001')</span><br><span class="line"></span><br><span class="line">for i in "$&#123;servs[@]&#125;"; do</span><br><span class="line">serv=($i)</span><br><span class="line">name="$&#123;serv[0]&#125;"</span><br><span class="line">port="$&#123;serv[1]&#125;"</span><br><span class="line">register $&#123;name&#125; $&#123;port&#125;</span><br><span class="line">done</span><br></pre></td></tr></table></figure><h3 id="或者用另一种方式，-在代码里使用-python-consul注册服务，-修改-firstapp-py"><a href="#或者用另一种方式，-在代码里使用-python-consul注册服务，-修改-firstapp-py" class="headerlink" title="或者用另一种方式， 在代码里使用 python-consul注册服务， 修改 firstapp.py"></a>或者用另一种方式， 在代码里使用 python-consul注册服务， 修改 firstapp.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">import</span> consul</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">"/sbin/ifconfig -a|grep inet|grep -v 127.0.0.1|grep -v inet6|awk '&#123;print $2&#125;'|tr -d \"addr:\""</span></span><br><span class="line">host = subprocess.check_output([cmd], shell=<span class="literal">True</span>).decode(<span class="string">"utf-8"</span>).strip()</span><br><span class="line">port = <span class="number">5000</span></span><br><span class="line"></span><br><span class="line">c = consul.Consul(host=<span class="string">'127.0.0.1'</span>,</span><br><span class="line">                  port=<span class="number">8500</span>,</span><br><span class="line">                  scheme=<span class="string">'http'</span>,</span><br><span class="line">                  token=<span class="literal">None</span>,</span><br><span class="line">                  verify=<span class="literal">True</span>,</span><br><span class="line">                  cert=<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">c.agent.service.register(name=<span class="string">'firstapp'</span>,</span><br><span class="line">                         service_id=<span class="string">'firstapp'</span>,</span><br><span class="line">                         address=host,</span><br><span class="line">                         port=port,</span><br><span class="line">                         tags=<span class="literal">None</span>,</span><br><span class="line">                         check=consul.Check().tcp(host=host,</span><br><span class="line">                                                  port=port,</span><br><span class="line">                                                  interval=<span class="string">"5s"</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    ver = <span class="string">"1.0"</span></span><br><span class="line">    res = <span class="string">'&#123;"Service":"first app", "Version":'</span> + ver + <span class="string">'&#125;\n'</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure><h3 id="修改secondapp-py"><a href="#修改secondapp-py" class="headerlink" title="修改secondapp.py"></a>修改secondapp.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">import</span> consul</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">cmd = <span class="string">"/sbin/ifconfig -a|grep inet|grep -v 127.0.0.1|grep -v inet6|awk '&#123;print $2&#125;'|tr -d \"addr:\""</span></span><br><span class="line">host = subprocess.check_output([cmd], shell=<span class="literal">True</span>).decode(<span class="string">"utf-8"</span>).strip()</span><br><span class="line">port = <span class="number">5001</span></span><br><span class="line"></span><br><span class="line">c = consul.Consul(host=<span class="string">'127.0.0.1'</span>,</span><br><span class="line">                  port=<span class="number">8500</span>,</span><br><span class="line">                  scheme=<span class="string">'http'</span>,</span><br><span class="line">                  token=<span class="literal">None</span>,</span><br><span class="line">                  verify=<span class="literal">True</span>,</span><br><span class="line">                  cert=<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">c.agent.service.register(name=<span class="string">'secondapp'</span>,</span><br><span class="line">                         service_id=<span class="string">'secondapp'</span>,</span><br><span class="line">                         address=host,</span><br><span class="line">                         port=port,</span><br><span class="line">                         tags=<span class="literal">None</span>,</span><br><span class="line">                         check=consul.Check().tcp(host=host,</span><br><span class="line">                                                  port=port,</span><br><span class="line">                                                  interval=<span class="string">"5s"</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getServiceAddress</span><span class="params">(name)</span>:</span></span><br><span class="line">    services = c.agent.services()</span><br><span class="line">    service = services.get(name)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> service:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    addr = <span class="string">"&#123;0&#125;:&#123;1&#125;"</span>.format(service[<span class="string">'Address'</span>], service[<span class="string">'Port'</span>])</span><br><span class="line">    <span class="keyword">return</span> service, addr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    ver = <span class="string">"1.0"</span></span><br><span class="line">    res = <span class="string">'&#123;"Service":"second app", "Version":'</span> + ver + <span class="string">'&#125;\n'</span></span><br><span class="line">    s = c.Agent.services(c.agent)[<span class="string">'firstapp'</span>]</span><br><span class="line">    serivce, addr = getServiceAddress(<span class="string">"firstapp"</span>)</span><br><span class="line">    res += requests.get(<span class="string">"http://&#123;0&#125;"</span>.format(addr), ).content.decode(<span class="string">'utf-8'</span>)</span><br><span class="line">    <span class="keyword">return</span> res</span><br></pre></td></tr></table></figure><p>到这就算成功略懂了</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;准备&quot;&gt;&lt;a href=&quot;#准备&quot; class=&quot;headerlink&quot; title=&quot;准备&quot;&gt;&lt;/a&gt;准备&lt;/h2&gt;&lt;p&gt;python3, flask, python-consul, docker&lt;/p&gt;
&lt;h3 id=&quot;使用docker-拉取-consul&quot;&gt;
      
    
    </summary>
    
    
    
      <category term="Python" scheme="https://liuxiujun.github.into/tags/Python/"/>
    
      <category term="后端" scheme="https://liuxiujun.github.into/tags/%E5%90%8E%E7%AB%AF/"/>
    
  </entry>
  
</feed>
